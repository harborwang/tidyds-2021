<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Classification</title>
    <meta charset="utf-8" />
    <meta name="author" content="W. Jake Thompson" />
    <meta name="date" content="2021-05-16" />
    <script src="libs/header-attrs/header-attrs.js"></script>
    <link href="libs/remark-css/default.css" rel="stylesheet" />
    <script src="libs/clipboard/clipboard.min.js"></script>
    <link href="libs/shareon/shareon.min.css" rel="stylesheet" />
    <script src="libs/shareon/shareon.min.js"></script>
    <link href="libs/xaringanExtra-shareagain/shareagain.css" rel="stylesheet" />
    <script src="libs/xaringanExtra-shareagain/shareagain.js"></script>
    <link href="libs/panelset/panelset.css" rel="stylesheet" />
    <script src="libs/panelset/panelset.js"></script>
    <link href="libs/xaringanExtra-extra-styles/xaringanExtra-extra-styles.css" rel="stylesheet" />
    <script src="libs/fabric/fabric.min.js"></script>
    <link href="libs/xaringanExtra-scribble/scribble.css" rel="stylesheet" />
    <script src="libs/xaringanExtra-scribble/scribble.js"></script>
    <script>document.addEventListener('DOMContentLoaded', function() { window.xeScribble = new Scribble({"pen_color":["#009FB7"],"pen_size":3,"eraser_size":30}) })</script>
    <link href="libs/countdown/countdown.css" rel="stylesheet" />
    <script src="libs/countdown/countdown.js"></script>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/all.css" integrity="sha384-oS3vJWv+0UjzBfQzYUhtDYW+Pj2yciDJxpsK1OYPAYjqT085Qq/1cq5FLXAZQ7Ay" crossorigin="anonymous">
    <link rel="stylesheet" href="assets/css/my-theme.css" type="text/css" />
    <link rel="stylesheet" href="assets/css/my-fonts.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">






class: title-slide, center

&lt;span class="fa-stack fa-4x"&gt;
  &lt;i class="fa fa-circle fa-stack-2x" style="color: #ffffff;"&gt;&lt;/i&gt;
  &lt;strong class="fa-stack-1x" style="color:#009FB7;"&gt;9&lt;/strong&gt;
&lt;/span&gt; 

# Classification

## Tidy Data Science with the Tidyverse and Tidymodels

### W. Jake Thompson

#### [https://tidyds-2021.wjakethompson.com](https://tidyds-2021.wjakethompson.com) &amp;#183; [https://bit.ly/tidyds-2021](https://bit.ly/tidyds-2021)

.footer-license[*Tidy Data Science with the Tidyverse and Tidymodels* is licensed under a [Creative Commons Attribution 4.0 International License](https://creativecommons.org/licenses/by/4.0/).]

&lt;div style = "position:fixed; visibility: hidden"&gt;
  `$$\require{color}\definecolor{blue}{rgb}{0, 0.623529411764706, 0.717647058823529}$$`
  `$$\require{color}\definecolor{light_blue}{rgb}{0.0392156862745098, 0.870588235294118, 1}$$`
  `$$\require{color}\definecolor{yellow}{rgb}{0.996078431372549, 0.843137254901961, 0.4}$$`
  `$$\require{color}\definecolor{dark_yellow}{rgb}{0.635294117647059, 0.47843137254902, 0.00392156862745098}$$`
  `$$\require{color}\definecolor{pink}{rgb}{0.796078431372549, 0.16078431372549, 0.482352941176471}$$`
  `$$\require{color}\definecolor{light_pink}{rgb}{1, 0.552941176470588, 0.776470588235294}$$`
  `$$\require{color}\definecolor{grey}{rgb}{0.411764705882353, 0.403921568627451, 0.450980392156863}$$`
&lt;/div&gt;
  
&lt;script type="text/x-mathjax-config"&gt;
  MathJax.Hub.Config({
    TeX: {
      Macros: {
        blue: ["{\\color{blue}{#1}}", 1],
        light_blue: ["{\\color{light_blue}{#1}}", 1],
        yellow: ["{\\color{yellow}{#1}}", 1],
        dark_yellow: ["{\\color{dark_yellow}{#1}}", 1],
        pink: ["{\\color{pink}{#1}}", 1],
        light_pink: ["{\\color{light_pink}{#1}}", 1],
        grey: ["{\\color{grey}{#1}}", 1]
      },
      loader: {load: ['[tex]/color']},
      tex: {packages: {'[+]': ['color']}}
    }
  });
&lt;/script&gt;

---
class: your-turn

# Your Turn 0

.big[
* Open the R Notebook **materials/exercises/09-classification.Rmd**
* Run the setup chunk
]

<div class="countdown" id="timer_60a1d1ca" style="right:0;bottom:0;font-size:2em;" data-warnwhen="0">
<code class="countdown-time"><span class="countdown-digits minutes">01</span><span class="countdown-digits colon">:</span><span class="countdown-digits seconds">00</span></code>
</div>

---
class: middle, center, frame

# Goal of Machine Learning

--


## 🔨 construct .display[models] that

--


## 🎯 generate .display[accurate predictions]

--


## 🆕 for .display[future, yet-to-be-seen data]

--

.footnote[Max Kuhn &amp; Kjell Johnston, http://www.feat.engineering/]

---
class: inverse, middle, center

A model doesn't have to be a straight line...

&lt;img src="images/classification/plots/lm-fig-1.svg" width="50%" style="display: block; margin: auto;" /&gt;

---
class: inverse, middle, center

.pull-left[
&lt;img src="images/classification/plots/lm-fig-1.svg" width="100%" style="display: block; margin: auto;" /&gt;
]

.pull-right[
&lt;img src="images/classification/plots/poly-fig-1.svg" width="100%" style="display: block; margin: auto;" /&gt;
]

---

# Decision Trees

.big[
To predict the outcome of a new data point:
]

* Use rules learned from splits

* Each split maximizes information gain

---
class: middle, center

![](https://media.giphy.com/media/gj4ZruUQUnpug/source.gif)

---


&lt;img src="images/classification/plots/rt-splits-1.png" width="55%" style="display: block; margin: auto;" /&gt;

---
&lt;img src="images/classification/plots/rt-split-smooth-1.png" width="55%" style="display: block; margin: auto;" /&gt;

---
class: pop-quiz

# Consider

.big[How do we assess predictions here?]

--

RMSE?

---
&lt;img src="images/classification/plots/rt-split-rmse-1.png" width="55%" style="display: block; margin: auto;" /&gt;

---

.pull-left[

### LM RMSE = 53884.78
&lt;img src="images/classification/plots/lm-test-resid-1.png" width="100%" style="display: block; margin: auto;" /&gt;

]

--

.pull-right[



### Tree RMSE = 61687.24
&lt;img src="images/classification/plots/print-rt-split-rmse-1.png" width="100%" style="display: block; margin: auto;" /&gt;

]

---
class: inverse, middle, center

.pull-left[
&lt;img src="images/classification/plots/print-lm-fit-1.svg" width="100%" style="display: block; margin: auto;" /&gt;
]

.pull-right[
&lt;img src="images/classification/plots/dt-fig-1.svg" width="100%" style="display: block; margin: auto;" /&gt;
]

---
class: middle, center, inverse

# What is a model?

---
# K Nearest Neighbors (KNN)

.big[
To predict the outcome of a new data point:
]

* Find the K most similar old data points

* Take the average/mode/etc. outcome

---


```r
library(kknn)
knn_spec &lt;- nearest_neighbor(neighbors = 5) %&gt;% 
           set_engine("kknn") %&gt;% 
           set_mode("regression")

set.seed(100)
knn_fit &lt;- fit(knn_spec, Sale_Price ~ ., data = ames_train)

knn_pred &lt;- knn_fit %&gt;% 
  predict(new_data = ames_test) %&gt;% 
  mutate(price_truth = ames_test$Sale_Price)

rmse(knn_pred, truth = price_truth, estimate = .pred)
#&gt; # A tibble: 1 x 3
#&gt;   .metric .estimator .estimate
#&gt;   &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;
#&gt; 1 rmse    standard      35870.

rsq(knn_pred, truth = price_truth, estimate = .pred)
#&gt; # A tibble: 1 x 3
#&gt;   .metric .estimator .estimate
#&gt;   &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;
#&gt; 1 rsq     standard       0.812
```

---
exclude: true





---

&lt;img src="images/classification/plots/knn-home1-1.png" width="55%" style="display: block; margin: auto;" /&gt;

---

&lt;img src="images/classification/plots/knn-home2-1.png" width="55%" style="display: block; margin: auto;" /&gt;

---

&lt;img src="images/classification/plots/knn-home2-10-1.png" width="55%" style="display: block; margin: auto;" /&gt;

---

&lt;img src="images/classification/plots/knn-home2-25-1.png" width="55%" style="display: block; margin: auto;" /&gt;

---

&lt;img src="images/classification/plots/knn-home2-50-1.png" width="55%" style="display: block; margin: auto;" /&gt;

---

.pull-left[
&lt;img src="images/classification/plots/knn-home2-1-1.png" width="100%" style="display: block; margin: auto;" /&gt;
]

.pull-right[
&lt;img src="images/classification/plots/underfit-knn-1.png" width="100%" style="display: block; margin: auto;" /&gt;
]

---
.pull-left[
&lt;img src="images/classification/plots/knn-home2-1.png" width="100%" style="display: block; margin: auto;" /&gt;
]

.pull-right[
&lt;img src="images/classification/plots/fit-knn-1.png" width="100%" style="display: block; margin: auto;" /&gt;
]

---
class: pop-quiz

# Pop quiz!

[Why is logistic regression considered a linear model?](https://sebastianraschka.com/faq/docs/logistic_regression_linear.html)

.center[
&lt;img src="images/classification/plots/lr-fig-1.svg" width="40%" style="display: block; margin: auto;" /&gt;
]

---
class: middle, center
&lt;img src="https://raw.githubusercontent.com/EmilHvitfeldt/blog/master/static/blog/2019-08-09-authorship-classification-with-tidymodels-and-textrecipes_files/figure-html/unnamed-chunk-18-1.png" width="70%" style="display: block; margin: auto;" /&gt;

https://www.hvitfeldt.me/blog/authorship-classification-with-tidymodels-and-textrecipes/

---
class: middle, center
&lt;img src="https://www.kaylinpavlik.com/content/images/2019/12/dt-1.png" width="50%" style="display: block; margin: auto;" /&gt;

https://www.kaylinpavlik.com/classifying-songs-genres/

---
class: middle, center
&lt;img src="images/classification/sing-tree.png" width="607" style="display: block; margin: auto;" /&gt;

[The Science of Singing Along](http://www.doc.gold.ac.uk/~mas03dm/papers/PawleyMullensiefen_Singalong_2012.pdf)

---
class: middle, center

&lt;img src="https://a3.typepad.com/6a0105360ba1c6970c01b7c95c61fb970b-pi" width="40%" style="display: block; margin: auto;" /&gt;

.footnote[[tweetbotornot2](https://github.com/mkearney/tweetbotornot2)]

---
name: guess-the-animal
class: middle, center, inverse

&lt;img src="http://www.atarimania.com/8bit/screens/guess_the_animal.gif" width="90%" style="display: block; margin: auto;" /&gt;

---
# What makes a good guesser?

--

.big[High information gain per question (can it fly?)]

--

.big[Clear features (feathers vs. is it "small"?)]

--

.big[Order matters]

---
class: inverse, middle, center

# Congratulations!

You just built a decision tree 🎉

---
background-image: url(images/classification/aus-standard-animals.png)
background-size: cover

.footnote[[Australian Computing Academy](https://aca.edu.au/resources/decision-trees-classifying-animals/)]

---
background-image: url(images/classification/annotated-tree-00.png)
background-size: 80%

.footnote[[Australian Computing Academy](https://aca.edu.au/resources/decision-trees-classifying-animals/)]

---
background-image: url(images/classification/annotated-tree-01.png)
background-size: 80%

---
background-image: url(images/classification/annotated-tree-02.png)
background-size: 80%

---
background-image: url(images/classification/annotated-tree-03.png)
background-size: 80%

---
background-image: url(images/classification/annotated-tree-04.png)
background-size: 80%

---
background-image: url(images/classification/annotated-tree-05.png)
background-size: 80%

---
background-image: url(images/classification/bonsai-anatomy.jpg)
background-size: cover

---
background-image: url(images/classification/bonsai-anatomy-flip.jpg)
background-size: cover

---
class: pop-quiz

# Pop quiz!

.big[Name that variable type!]

&lt;img src="images/classification/vartypes_quiz.png" width="60%" style="display: block; margin: auto;" /&gt;

<div class="countdown" id="timer_60a1d432" style="right:0;bottom:0;" data-warnwhen="0">
<code class="countdown-time"><span class="countdown-digits minutes">02</span><span class="countdown-digits colon">:</span><span class="countdown-digits seconds">00</span></code>
</div>

---
class: pop-quiz

&lt;img src="images/classification/vartypes_answers.png" width="80%" style="display: block; margin: auto;" /&gt;

---
class: pop-quiz

&lt;img src="images/classification/vartypes_unicorn.jpeg" width="80%" style="display: block; margin: auto;" /&gt;

---
class: center, middle

# Show of hands

How many people have .display[fit] a logistic regression model with `glm()`?

---
exclude: true



---
class: middle, center, inverse

.pull-left[
&lt;img src="images/classification/plots/show-unicorn-1.png" width="1695" style="display: block; margin: auto;" /&gt;

]

.pull-right[
&lt;img src="images/classification/plots/show-horse-1.png" width="1695" style="display: block; margin: auto;" /&gt;
]

---

.pull-left[

```r
uni_train %&gt;% 
  count(unicorn)
#&gt;   unicorn   n
#&gt; 1       0 100
#&gt; 2       1  50
```
]

.pull-right[
&lt;img src="images/classification/plots/unicorn-box-1.png" width="100%" style="display: block; margin: auto;" /&gt;

]

---

&lt;img src="images/classification/plots/unicorn-density-1.png" width="55%" style="display: block; margin: auto;" /&gt;

---



&lt;img src="images/classification/plots/unicorn-lr-1.png" width="55%" style="display: block; margin: auto;" /&gt;

???

Logistic regression model

---
&lt;img src="images/classification/plots/unicorn-probs-1.png" width="55%" style="display: block; margin: auto;" /&gt;

???

The probability that each observation is a unicorn

---
&lt;img src="images/classification/plots/unicorn-pred-class-1.png" width="55%" style="display: block; margin: auto;" /&gt;

???

Predicted class of each observation

---
class: middle, center


&lt;img src="images/classification/plots/unicorn-clusters-1.png" width="55%" style="display: block; margin: auto;" /&gt;

---




```
#&gt; parsnip model object
#&gt; 
#&gt; Fit time:  2ms 
#&gt; n= 150 
#&gt; 
#&gt; node), split, n, loss, yval, (yprob)
#&gt;       * denotes terminal node
#&gt; 
#&gt; 1) root 150 50 0 (0.6666667 0.3333333)  
#&gt;   2) n_butterflies&gt;=29.5 93 16 0 (0.8279570 0.1720430) *
#&gt;   3) n_butterflies&lt; 29.5 57 23 1 (0.4035088 0.5964912)  
#&gt;     6) n_kittens&gt;=62.5 18  6 0 (0.6666667 0.3333333) *
#&gt;     7) n_kittens&lt; 62.5 39 11 1 (0.2820513 0.7179487) *
```

---
&lt;img src="images/classification/plots/uni-tree-partykit-1.png" width="720" style="display: block; margin: auto;" /&gt;

---


```
#&gt;  nn ..y    0   1                                               cover
#&gt;   2   0 [.83 .17] when n_butterflies &gt;= 30                       62%
#&gt;   6   0 [.67 .33] when n_butterflies &lt;  30 &amp; n_kittens &gt;= 63     12%
#&gt;   7   1 [.28 .72] when n_butterflies &lt;  30 &amp; n_kittens &lt;  63     26%
```

---



.pull-left[
&lt;img src="images/classification/plots/og-data-no-div-1.png" width="100%" style="display: block; margin: auto;" /&gt;
]

--

.pull-right[
&lt;img src="images/classification/plots/pred-data-no-div-1.png" width="100%" style="display: block; margin: auto;" /&gt;

]

---

.pull-left[

&lt;img src="images/classification/plots/kitten-div-1-1.png" width="100%" style="display: block; margin: auto;" /&gt;


]

--

.pull-right[

&lt;img src="images/classification/plots/butterfly-div-1-1.png" width="100%" style="display: block; margin: auto;" /&gt;

]

--

### .center[🦋 split wins]

---

.pull-left[

&lt;img src="images/classification/plots/kitten-div-2-1.png" width="100%" style="display: block; margin: auto;" /&gt;


]

--

.pull-right[

&lt;img src="images/classification/plots/butterfly-div-2-1.png" width="100%" style="display: block; margin: auto;" /&gt;

]

--

### .center[🐱 split wins]

---
class: middle, center

# Sadly, we are not classifying unicorns today

&lt;img src="images/classification/sad_unicorn.png" width="20%" style="display: block; margin: auto;" /&gt;

---
background-image: url(images/classification/copyingandpasting-big.png)
background-size: contain
background-position: center
class: middle, center

---
background-image: url(images/classification/so-dev-survey.png)
background-size: contain
background-position: center
class: middle, center

---

&lt;img src="https://github.com/juliasilge/supervised-ML-case-studies-course/blob/master/img/remote_size.png?raw=true" width="80%" style="display: block; margin: auto;" /&gt;

.footnote[[Julia Silge](https://supervised-ml-course.netlify.app/)]

???

Notes: The specific question we are going to address is what makes a developer more likely to work remotely. Developers can work in their company offices or they can work remotely, and it turns out that there are specific characteristics of developers, such as the size of the company that they work for, how much experience they have, or where in the world they live, that affect how likely they are to be a remote developer.

---

# StackOverflow Data




```r
glimpse(stackoverflow)
#&gt; Rows: 1,150
#&gt; Columns: 21
#&gt; $ country                              &lt;fct&gt; United States, United States, Uni…
#&gt; $ salary                               &lt;dbl&gt; 63750.00, 93000.00, 40625.00, 450…
#&gt; $ years_coded_job                      &lt;int&gt; 4, 9, 8, 3, 8, 12, 20, 17, 20, 4,…
#&gt; $ open_source                          &lt;dbl&gt; 0, 1, 1, 1, 0, 1, 0, 0, 0, 0, 1, …
#&gt; $ hobby                                &lt;dbl&gt; 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 1, …
#&gt; $ company_size_number                  &lt;dbl&gt; 20, 1000, 10000, 1, 10, 100, 20, …
#&gt; $ remote                               &lt;fct&gt; Remote, Remote, Remote, Remote, R…
#&gt; $ career_satisfaction                  &lt;int&gt; 8, 8, 5, 10, 8, 10, 9, 7, 8, 7, 9…
#&gt; $ data_scientist                       &lt;dbl&gt; 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, …
#&gt; $ database_administrator               &lt;dbl&gt; 1, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, …
#&gt; $ desktop_applications_developer       &lt;dbl&gt; 1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, …
#&gt; $ developer_with_stats_math_background &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, …
#&gt; $ dev_ops                              &lt;dbl&gt; 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, …
#&gt; $ embedded_developer                   &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, …
#&gt; $ graphic_designer                     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, …
#&gt; $ graphics_programming                 &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, …
#&gt; $ machine_learning_specialist          &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, …
#&gt; $ mobile_developer                     &lt;dbl&gt; 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 0, …
#&gt; $ quality_assurance_engineer           &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, …
#&gt; $ systems_administrator                &lt;dbl&gt; 1, 0, 1, 0, 0, 1, 0, 0, 0, 0, 0, …
#&gt; $ web_developer                        &lt;dbl&gt; 0, 0, 0, 1, 1, 1, 0, 1, 0, 1, 1, …
```

---

# `initial_split()`

.big["Splits" data randomly into a single testing and a single training set;
extract `training` and `testing` sets from an rsplit]


```r
set.seed(100) # Important!
so_split &lt;- initial_split(stackoverflow, strata = remote)
so_train &lt;- training(so_split)
so_test  &lt;- testing(so_split)
```

---
class: your-turn

# Your turn 1

.big[Using the `so_train` and `so_test` data sets, how many individuals in our training set are remote? How about in the testing set?]

<div class="countdown" id="timer_60a1d23f" style="right:0;bottom:0;" data-warnwhen="0">
<code class="countdown-time"><span class="countdown-digits minutes">02</span><span class="countdown-digits colon">:</span><span class="countdown-digits seconds">00</span></code>
</div>

---
class: your-turn


```r
so_train %&gt;% 
  count(remote)
#&gt; # A tibble: 2 x 2
#&gt;   remote         n
#&gt;   &lt;fct&gt;      &lt;int&gt;
#&gt; 1 Remote       432
#&gt; 2 Not remote   432

so_test %&gt;% 
  count(remote)
#&gt; # A tibble: 2 x 2
#&gt;   remote         n
#&gt;   &lt;fct&gt;      &lt;int&gt;
#&gt; 1 Remote       143
#&gt; 2 Not remote   143
```

---

.pull-left[

```r
so_train %&gt;% 
  count(remote)
#&gt; # A tibble: 2 x 2
#&gt;   remote         n
#&gt;   &lt;fct&gt;      &lt;int&gt;
#&gt; 1 Remote       432
#&gt; 2 Not remote   432

so_test %&gt;% 
  count(remote)
#&gt; # A tibble: 2 x 2
#&gt;   remote         n
#&gt;   &lt;fct&gt;      &lt;int&gt;
#&gt; 1 Remote       143
#&gt; 2 Not remote   143
```

]

.pull-right[

&lt;img src="images/classification/plots/so-box-1.png" width="100%" style="display: block; margin: auto;" /&gt;
]

---
class: inverse


# How would we fit a tree with parsnip?

&lt;img src="images/hex/parsnip.png" width="30%" style="display: block; margin: auto;" /&gt;

---
class: middle, frame


# .center[To specify a model with parsnip]

.right-column[

1\. Pick a .display[model]

2\. Set the .display[engine]

3\. Set the .display[mode] (if needed)

]

---
# 1\. Pick a .display[model] 

All available models are listed at &lt;https://www.tidymodels.org/find/parsnip/&gt;

.center[
&lt;iframe src="https://www.tidymodels.org/find/parsnip/" width="80%" height="400px"&gt;&lt;/iframe&gt;
]

---
# 2\. Set the .display[engine] 

We'll use `rpart` for building `C`lassification `A`nd `R`egression `T`rees


```r
set_engine("rpart") 
```

---
# 3\. Set the .display[mode] 

A character string for the model type (e.g. "classification" or "regression")


```r
set_mode("classification") 
```

---
class: middle, frame

# .center[To specify a model with parsnip]


```r
decision_tree() %&gt;%
  set_engine("rpart") %&gt;%
  set_mode("classification")
```

---
class: your-turn

# Your turn 2

Fill in the blanks. Use the `tree_spec` model provided and `fit()` to:

1. Train a CART-based model with the formula = `remote ~ years_coded_job + salary`.

1. Remind yourself what the output looks like!

1. Predict remote status with the testing data.

1. Keep `set.seed(100)` at the start of your code.  

<div class="countdown" id="timer_60a1d299" style="right:0;bottom:0;" data-warnwhen="0">
<code class="countdown-time"><span class="countdown-digits minutes">05</span><span class="countdown-digits colon">:</span><span class="countdown-digits seconds">00</span></code>
</div>

---
class: your-turn

.panelset[
.panel[.panel-name[Fit Model]

```r
tree_spec &lt;- 
  decision_tree() %&gt;%         
  set_engine("rpart") %&gt;%      
  set_mode("classification")

set.seed(100) # Important!
tree_fit &lt;- fit(tree_spec,
                remote ~ years_coded_job + salary,
                data = so_train) 
```
]

.panel[.panel-name[View Model]

```r
tree_fit
#&gt; parsnip model object
#&gt; 
#&gt; Fit time:  7ms 
#&gt; n= 864 
#&gt; 
#&gt; node), split, n, loss, yval, (yprob)
#&gt;       * denotes terminal node
#&gt; 
#&gt; 1) root 864 432 Remote (0.5000000 0.5000000)  
#&gt;   2) salary&gt;=89196.97 329 103 Remote (0.6869301 0.3130699) *
#&gt;   3) salary&lt; 89196.97 535 206 Not remote (0.3850467 0.6149533)  
#&gt;     6) salary&lt; 6423.433 40  16 Remote (0.6000000 0.4000000) *
#&gt;     7) salary&gt;=6423.433 495 182 Not remote (0.3676768 0.6323232) *
```
]

.panel[.panel-name[Make Predictions]

```r
predict(tree_fit, new_data = so_test)
#&gt; # A tibble: 286 x 1
#&gt;    .pred_class
#&gt;    &lt;fct&gt;      
#&gt;  1 Remote     
#&gt;  2 Remote     
#&gt;  3 Not remote 
#&gt;  4 Not remote 
#&gt;  5 Remote     
#&gt;  6 Not remote 
#&gt;  7 Remote     
#&gt;  8 Not remote 
#&gt;  9 Remote     
#&gt; 10 Not remote 
#&gt; # … with 276 more rows
```
]
]

---

class: middle, center, frame

# Goal of Machine Learning


## 🔨 construct .display[models] that

.fade[

## 🔮 generate accurate .display[predictions]

## 🆕 for .display[future, yet-to-be-seen data]

]

---

class: middle, center, frame

# Goal of Machine Learning


.fade[
## 🔨 construct .display[models] that



## 🔮 generate accurate .display[predictions]

]


## 🆕 for .display[future, yet-to-be-seen data]

---

class: middle, center, frame

# Goal of Machine Learning


.fade[
## 🔨 construct .display[models] that

]

## 🔮 generate accurate .display[predictions]

.fade[

## 🆕 for .display[future, yet-to-be-seen data]

]
---

class: middle, center, frame

# Goal of Machine Learning


.fade[
## 🔨 construct .display[models] that

]

## 🎯 generate .display[accurate predictions]

.fade[

## 🆕 for .display[future, yet-to-be-seen data]

]

---
class: your-turn

# Your turn 3

Create a data frame of the observed and predicted remote status for the `so_test` data. Then use `count()` to count the number of individuals (i.e., rows) by their true and predicted remote status. Answer the following questions:

1. How many predictions did we make?

1. How many times is "remote" status predicted?

1. How many respondents are actually remote?

1. How many predictions did we get right?

*Hint: You can create a 2x2 table using* `count(var1, var2)`

<div class="countdown" id="timer_60a1d2fc" style="right:0;bottom:0;" data-warnwhen="0">
<code class="countdown-time"><span class="countdown-digits minutes">06</span><span class="countdown-digits colon">:</span><span class="countdown-digits seconds">00</span></code>
</div>

---
class: your-turn

.panelset[
.panel[.panel-name[Create Predictions]

```r
tree_predict &lt;- predict(tree_fit, new_data = so_test)

all_preds &lt;- so_test %&gt;%
  select(remote) %&gt;%
  bind_cols(tree_predict)

all_preds
#&gt; # A tibble: 286 x 2
#&gt;    remote .pred_class
#&gt;    &lt;fct&gt;  &lt;fct&gt;      
#&gt;  1 Remote Remote     
#&gt;  2 Remote Remote     
#&gt;  3 Remote Not remote 
#&gt;  4 Remote Not remote 
#&gt;  5 Remote Remote     
#&gt;  6 Remote Not remote 
#&gt;  7 Remote Remote     
#&gt;  8 Remote Not remote 
#&gt;  9 Remote Remote     
#&gt; 10 Remote Not remote 
#&gt; # … with 276 more rows
```
]

.panel[.panel-name[Evalutate Predictions]

```r
all_preds %&gt;%
  count(.pred_class, truth = remote)
#&gt; # A tibble: 4 x 3
#&gt;   .pred_class truth          n
#&gt;   &lt;fct&gt;       &lt;fct&gt;      &lt;int&gt;
#&gt; 1 Remote      Remote        89
#&gt; 2 Remote      Not remote    40
#&gt; 3 Not remote  Remote        54
#&gt; 4 Not remote  Not remote   103
```
]
]

---
# `conf_mat()`

.big[
Creates confusion matrix, or truth table, from a data frame with observed and predicted classes.
]


```r
conf_mat(data, truth = remote, estimate = .pred_class)
```

---

```r
all_preds %&gt;%
  conf_mat(truth = remote, estimate = .pred_class)
#&gt;             Truth
#&gt; Prediction   Remote Not remote
#&gt;   Remote         89         40
#&gt;   Not remote     54        103
```

---

```r
all_preds %&gt;%
  conf_mat(truth = remote, estimate = .pred_class) %&gt;%
  autoplot(type = "heatmap")
```

&lt;img src="images/classification/plots/conf-map-heat-1.png" width="40%" style="display: block; margin: auto;" /&gt;

---
background-image: url(images/classification/metrics/metrics-01.png)
background-position: 50% 90%
background-size: 80%

# Confusion matrix

---
background-image: url(images/classification/metrics/metrics-02.png)
background-position: 50% 90%
background-size: 80%

# Confusion matrix

---
background-image: url(images/classification/metrics/metrics-03.png)
background-position: 50% 90%
background-size: 80%

# Confusion matrix

---
background-image: url(images/classification/metrics/metrics-04.png)
background-position: 50% 90%
background-size: 80%

# Confusion matrix

---
background-image: url(images/classification/metrics/metrics-05.png)
background-position: 50% 90%
background-size: 80%

# Accuracy

---
background-image: url(images/classification/metrics/metrics-06.png)
background-position: 50% 90%
background-size: 80%

# Accuracy

---
background-image: url(images/classification/metrics/metrics-07.png)
background-position: 50% 90%
background-size: 80%

# Accuracy

---
background-image: url(images/classification/metrics/metrics-01.png)
background-position: 50% 90%
background-size: 80%

# Sensitivity vs. Specificity

---
background-image: url(images/classification/metrics/metrics-08.png)
background-position: 50% 90%
background-size: 80%

# Sensitivity

---
background-image: url(images/classification/metrics/metrics-09.png)
background-position: 50% 90%
background-size: 80%

# Sensitivity

---
background-image: url(images/classification/metrics/metrics-10.png)
background-position: 50% 90%
background-size: 80%

# Specificity

---
background-image: url(images/classification/metrics/metrics-11.png)
background-position: 50% 90%
background-size: 80%

# Specificity

---
# Metrics

All available metrics are listed at &lt;https://yardstick.tidymodels.org/articles/metric-types.html#metrics&gt;

.center[
&lt;iframe src="https://yardstick.tidymodels.org/articles/metric-types.html#metrics" width="80%" height="400px"&gt;&lt;/iframe&gt;
]

---
# Calculating metrics


```r
accuracy(all_preds, truth = remote, estimate = .pred_class)
#&gt; # A tibble: 1 x 3
#&gt;   .metric  .estimator .estimate
#&gt;   &lt;chr&gt;    &lt;chr&gt;          &lt;dbl&gt;
#&gt; 1 accuracy binary         0.671

sensitivity(all_preds, truth = remote, estimate = .pred_class)
#&gt; # A tibble: 1 x 3
#&gt;   .metric .estimator .estimate
#&gt;   &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;
#&gt; 1 sens    binary         0.622

specificity(all_preds, truth = remote, estimate = .pred_class)
#&gt; # A tibble: 1 x 3
#&gt;   .metric .estimator .estimate
#&gt;   &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;
#&gt; 1 spec    binary         0.720
```

---
# `metric_set()`

.big[Combine multiple metrics functions together.]


```r
so_metrics &lt;- metric_set(accuracy, sensitivity, specificity)

so_metrics(all_preds, truth = remote, estimate = .pred_class)
#&gt; # A tibble: 3 x 3
#&gt;   .metric  .estimator .estimate
#&gt;   &lt;chr&gt;    &lt;chr&gt;          &lt;dbl&gt;
#&gt; 1 accuracy binary         0.671
#&gt; 2 sens     binary         0.622
#&gt; 3 spec     binary         0.720
```

---
# `roc_curve()`

.big[
Takes predictions, returns a tibble with probabilities.
]


```r
roc_curve(all_preds, truth = remote, estimate = .pred_Remote)
```

.big[
Truth = the .display[observed] class

Estimate = the .display[probability] of the target response
]

???

We don't have `.pred_Remote`. How do we get that?

---

```r
all_preds &lt;- so_test %&gt;%
  select(remote) %&gt;%
  bind_cols(predict(tree_fit, new_data = so_test)) %&gt;%
  bind_cols(predict(tree_fit, new_data = so_test, type = "prob"))

all_preds
#&gt; # A tibble: 286 x 4
#&gt;    remote .pred_class .pred_Remote `.pred_Not remote`
#&gt;    &lt;fct&gt;  &lt;fct&gt;              &lt;dbl&gt;              &lt;dbl&gt;
#&gt;  1 Remote Remote             0.687              0.313
#&gt;  2 Remote Remote             0.687              0.313
#&gt;  3 Remote Not remote         0.368              0.632
#&gt;  4 Remote Not remote         0.368              0.632
#&gt;  5 Remote Remote             0.687              0.313
#&gt;  6 Remote Not remote         0.368              0.632
#&gt;  7 Remote Remote             0.687              0.313
#&gt;  8 Remote Not remote         0.368              0.632
#&gt;  9 Remote Remote             0.687              0.313
#&gt; 10 Remote Not remote         0.368              0.632
#&gt; # … with 276 more rows
```

---
# `roc_curve()`


```r
roc_curve(all_preds, truth = remote, estimate = .pred_Remote)
#&gt; # A tibble: 5 x 3
#&gt;   .threshold specificity sensitivity
#&gt;        &lt;dbl&gt;       &lt;dbl&gt;       &lt;dbl&gt;
#&gt; 1   -Inf           0           1    
#&gt; 2      0.368       0           1    
#&gt; 3      0.6         0.720       0.622
#&gt; 4      0.687       0.762       0.573
#&gt; 5    Inf           1           0
```

???

`.threshold` = probability threshold needed to place an individual in the class.

---
class: your-turn

# Your turn 4

.big[
Build the necessary data frame, and use `roc_curve()` to calculate the data needed to construct the full ROC curve.

What is the necessary threshold for achieving specificity &gt;.75?
]

<div class="countdown" id="timer_60a1d26b" style="right:0;bottom:0;" data-warnwhen="0">
<code class="countdown-time"><span class="countdown-digits minutes">05</span><span class="countdown-digits colon">:</span><span class="countdown-digits seconds">00</span></code>
</div>

---
class: your-turn


```r
all_preds &lt;- so_test %&gt;%
  select(remote) %&gt;%
  bind_cols(predict(tree_fit, new_data = so_test)) %&gt;%
  bind_cols(predict(tree_fit, new_data = so_test, type = "prob"))

roc_curve(all_preds, truth = remote, estimate = .pred_Remote)
#&gt; # A tibble: 5 x 3
#&gt;   .threshold specificity sensitivity
#&gt;        &lt;dbl&gt;       &lt;dbl&gt;       &lt;dbl&gt;
#&gt; 1   -Inf           0           1    
#&gt; 2      0.368       0           1    
#&gt; 3      0.6         0.720       0.622
#&gt; 4      0.687       0.762       0.573
#&gt; 5    Inf           1           0
```

???

For specificity of .75, we need a threshold of .687.

---
.panelset[
.panel[.panel-name[Plot Code]

```r
roc_curve(all_preds, truth = remote, estimate = .pred_Remote) %&gt;%
  ggplot(mapping = aes(x = 1 - specificity, y = sensitivity)) +
  geom_line(color = "midnightblue", size = 1.5) +
  geom_abline(lty = 2, alpha = 0.5, color = "gray50", size = 1.2)
```

]

.panel[.panel-name[Plot]

&lt;img src="images/classification/plots/yt-roccurve-plot-1.png" width="50%" style="display: block; margin: auto;" /&gt;

]
]

---

```r
roc_curve(all_preds, truth = remote, estimate = .pred_Remote) %&gt;%
  autoplot()
```

&lt;img src="images/classification/plots/roccurve-autoplot-1.png" width="50%" style="display: block; margin: auto;" /&gt;

---
# Area under the curve

.pull-left[
&lt;img src="images/classification/plots/good-rocauc-1.png" width="100%" style="display: block; margin: auto;" /&gt;
]

.pull-right[
* AUC = 0.5: random guessing

* AUC = 1: perfect classifer

* In general AUC of above 0.8 considered "good"

* {yardstick} metric: `roc_auc()`
]

---
# ROC curve: Guessing

&lt;img src="images/classification/plots/guess-rocauc-1.png" width="70%" style="display: block; margin: auto;" /&gt;

---
# ROC curve: Perfect

&lt;img src="images/classification/plots/perfect-rocauc-1.png" width="70%" style="display: block; margin: auto;" /&gt;

---
# ROC curve: Poor

&lt;img src="images/classification/plots/poor-rocauc-1.png" width="70%" style="display: block; margin: auto;" /&gt;

---
# ROC curve: OK

&lt;img src="images/classification/plots/ok-rocauc-1.png" width="70%" style="display: block; margin: auto;" /&gt;

---
# ROC curve: Good

&lt;img src="images/classification/plots/print-good-rocauc-1.png" width="70%" style="display: block; margin: auto;" /&gt;

---
class: your-turn

# Your turn 5

.big[
Use `roc_auc()` to calculate the area under the ROC curve. Then plot the ROC curve using `autoplot()`.
]

<div class="countdown" id="timer_60a1d377" style="right:0;bottom:0;" data-warnwhen="0">
<code class="countdown-time"><span class="countdown-digits minutes">05</span><span class="countdown-digits colon">:</span><span class="countdown-digits seconds">00</span></code>
</div>


---
class: your-turn

.panelset[
.panel[.panel-name[Code]

```r
roc_auc(all_preds, truth = remote, estimate = .pred_Remote)
#&gt; # A tibble: 1 x 3
#&gt;   .metric .estimator .estimate
#&gt;   &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;
#&gt; 1 roc_auc binary         0.678

roc_curve(all_preds, truth = remote, estimate = .pred_Remote) %&gt;%
  autoplot()
```
]

.panel[.panel-name[Plot]
&lt;img src="images/classification/plots/yt-rocauc-sol-1.png" width="80%" style="display: block; margin: auto;" /&gt;
]
]

---
class: title-slide, center

# Classification

&lt;img src="images/classification/pred-hex.png" width="40%" style="display: block; margin: auto;" /&gt;

## Tidy Data Science with the Tidyverse and Tidymodels

### W. Jake Thompson

#### [https://tidyds-2021.wjakethompson.com](https://tidyds-2021.wjakethompson.com) &amp;#183; [https://bit.ly/tidyds-2021](https://bit.ly/tidyds-2021)

.footer-license[*Tidy Data Science with the Tidyverse and Tidymodels* is licensed under a [Creative Commons Attribution 4.0 International License](https://creativecommons.org/licenses/by/4.0/).]
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script src="https://platform.twitter.com/widgets.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "solarized-light",
"highlightLanguage": ["r", "css", "yaml"],
"slideNumberFormat": "",
"highlightLines": true,
"countIncrementalSlides": false,
"ratio": "16:9"
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
